"""
SUMMA Model Configuration.

Provides configuration schema, defaults, transformers, and validation
for the Structure for Unifying Multiple Modeling Alternatives (SUMMA).

This module registers SUMMA-specific configuration components with the
ModelRegistry, enabling the core config system to remain model-agnostic.

PHASE 2 REFACTORING: This adapter now uses AutoGeneratedConfigAdapter
to auto-generate defaults and transformers from Pydantic Field declarations.
All defaults are maintained in SUMMAConfig (model_configs.py) for single
source of truth.
"""

from typing import Dict, Any
from symfluence.models.base import AutoGeneratedConfigAdapter, ConfigValidationError
from symfluence.core.config.models.model_configs import SUMMAConfig


# ============================================================================
# SUMMA Config Adapter
# ============================================================================

class SUMMAConfigAdapter(AutoGeneratedConfigAdapter):
    """
    Configuration adapter for SUMMA model with auto-generated defaults and transformers.

    Defaults and transformers are automatically extracted from SUMMAConfig
    Pydantic model. Only custom validation logic is implemented here.

    This reduces boilerplate from ~270 lines to ~120 lines while maintaining
    all functionality. All defaults are now in SUMMAConfig Field declarations.

    Example:
        >>> from symfluence.models.registry import ModelRegistry
        >>> adapter = ModelRegistry.get_config_adapter('SUMMA')
        >>> defaults = adapter.get_defaults()  # Auto-generated from SUMMAConfig
        >>> schema = adapter.get_config_schema()
    """

    def __init__(self, model_name: str = 'SUMMA'):
        super().__init__(model_name)

    def get_config_schema(self):
        """Return SUMMA Pydantic configuration schema."""
        return SUMMAConfig

    def validate(self, config: Dict[str, Any]) -> None:
        """
        Validate SUMMA-specific configuration.

        Args:
            config: Configuration dictionary (flat format with uppercase keys)

        Raises:
            ConfigValidationError: If configuration is invalid
        """
        # Check required fields
        required_fields = self.get_required_keys()
        missing_fields = []

        for field in required_fields:
            value = config.get(field)
            if value is None or value == '' or value == 'None':
                missing_fields.append(field)

        if missing_fields:
            raise ConfigValidationError(
                f"SUMMA configuration incomplete. Missing required fields:\n"
                + "\n".join(f"  • {field}" for field in missing_fields)
            )

        # Validate mizuRoute requirements if routing is enabled
        routing_model = config.get('ROUTING_MODEL', '').upper()
        if routing_model == 'MIZUROUTE':
            mizu_required = ['INSTALL_PATH_MIZUROUTE', 'EXE_NAME_MIZUROUTE']
            mizu_missing = [
                f for f in mizu_required
                if not config.get(f) or config.get(f) in ['', 'None']
            ]
            if mizu_missing:
                raise ConfigValidationError(
                    f"mizuRoute routing enabled but configuration incomplete:\n"
                    + "\n".join(f"  • {field}" for field in mizu_missing)
                )

        # Validate parallel SUMMA requirements
        if config.get('SETTINGS_SUMMA_USE_PARALLEL_SUMMA'):
            parallel_required = {
                'SETTINGS_SUMMA_GRU_COUNT': config.get('SETTINGS_SUMMA_GRU_COUNT'),
                'SETTINGS_SUMMA_GRU_PER_JOB': config.get('SETTINGS_SUMMA_GRU_PER_JOB'),
            }
            parallel_missing = [
                field for field, value in parallel_required.items()
                if value is None or value == 0
            ]
            if parallel_missing:
                raise ConfigValidationError(
                    f"Parallel SUMMA enabled but configuration incomplete:\n"
                    + "\n".join(f"  • {field}" for field in parallel_missing)
                )

        # Validate glacier mode requirements
        if config.get('SETTINGS_SUMMA_GLACIER_MODE'):
            glacier_files = {
                'SETTINGS_SUMMA_GLACIER_ATTRIBUTES': config.get('SETTINGS_SUMMA_GLACIER_ATTRIBUTES'),
                'SETTINGS_SUMMA_GLACIER_COLDSTATE': config.get('SETTINGS_SUMMA_GLACIER_COLDSTATE'),
            }
            glacier_missing = [
                field for field, value in glacier_files.items()
                if not value or value in ['', 'None', 'default']
            ]
            if glacier_missing:
                raise ConfigValidationError(
                    f"Glacier mode enabled but configuration incomplete:\n"
                    + "\n".join(f"  • {field}" for field in glacier_missing)
                )

    def get_required_keys(self) -> list:
        """Get list of required configuration keys for SUMMA."""
        return [
            'SUMMA_EXE',
            'SETTINGS_SUMMA_PATH',
        ]

    def get_conditional_requirements(self) -> Dict[str, Dict[str, list]]:
        """Get conditional requirements based on other config values."""
        return {
            'ROUTING_MODEL': {
                'mizuRoute': ['INSTALL_PATH_MIZUROUTE', 'EXE_NAME_MIZUROUTE'],
                'MIZUROUTE': ['INSTALL_PATH_MIZUROUTE', 'EXE_NAME_MIZUROUTE'],
                'none': [],
            },
            'SETTINGS_SUMMA_USE_PARALLEL_SUMMA': {
                True: ['SETTINGS_SUMMA_GRU_COUNT', 'SETTINGS_SUMMA_GRU_PER_JOB'],
                False: [],
            },
            'SETTINGS_SUMMA_GLACIER_MODE': {
                True: ['SETTINGS_SUMMA_GLACIER_ATTRIBUTES', 'SETTINGS_SUMMA_GLACIER_COLDSTATE'],
                False: [],
            },
        }
