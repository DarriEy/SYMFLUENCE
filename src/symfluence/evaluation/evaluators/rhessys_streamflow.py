#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
RHESSys Streamflow Evaluator

Evaluates RHESSys model streamflow output against observations.
"""

import logging
import pandas as pd
from pathlib import Path
from typing import List, Optional

from symfluence.evaluation.registry import EvaluationRegistry
from .streamflow import StreamflowEvaluator

@EvaluationRegistry.register('RHESSYS_STREAMFLOW')
class RHESSysStreamflowEvaluator(StreamflowEvaluator):
    """Streamflow evaluator for RHESSys model outputs"""

    def _load_observed_data(self) -> Optional[pd.Series]:
        """
        Load observed data and resample to daily frequency (matching RHESSys output).
        """
        try:
            obs_path = self.get_observed_data_path()
            obs_series = self._load_observed_data_from_path(obs_path)

            if obs_series is not None:
                # Resample to daily frequency (mean) to match RHESSys output frequency
                obs_daily = obs_series.resample('D').mean()
                self.logger.info(f"Resampled observations from {len(obs_series)} to {len(obs_daily)} daily values")
                return obs_daily

            return obs_series

        except Exception as e:
            self.logger.error(f"Error loading observed data: {str(e)}")
            return None

    def get_simulation_files(self, sim_dir: Path) -> List[Path]:
        """Get RHESSys output files (CSV or basin.daily)"""
        # Priority 1: Results CSV (generated by postprocessor)
        results_csv = sim_dir / 'rhessys_results.csv'
        if results_csv.exists():
            return [results_csv]

        # Priority 2: Basin daily file (standard RHESSys output)
        basin_daily = sim_dir / 'rhessys_basin.daily'
        if basin_daily.exists():
            return [basin_daily]

        # Priority 3: Any basin daily file
        basin_files = list(sim_dir.glob("*_basin.daily"))
        if basin_files:
            return basin_files[:1]  # Return first match

        self.logger.warning(f"No RHESSys output files found in {sim_dir}")
        return []

    def extract_simulated_data(self, sim_files: List[Path], **kwargs) -> pd.Series:
        """Extract streamflow data from RHESSys output files"""
        if not sim_files:
            raise ValueError("No simulation files provided")

        sim_file = sim_files[0]
        self.logger.info(f"Extracting simulated streamflow from: {sim_file}")

        if sim_file.suffix == '.csv':
            return self._extract_from_csv(sim_file)
        else:
            return self._extract_from_basin_daily(sim_file)

    def _extract_from_csv(self, sim_file: Path) -> pd.Series:
        """Extract streamflow from RHESSys results CSV"""
        df = pd.read_csv(sim_file, index_col=0, parse_dates=True)

        # RHESSys results CSV has streamflow_cms column
        if 'streamflow_cms' in df.columns:
            q_sim = df['streamflow_cms']
        elif 'discharge' in df.columns:
            q_sim = df['discharge']
        elif 'streamflow' in df.columns:
            q_sim = df['streamflow']
        else:
            # Use first numeric column
            numeric_cols = df.select_dtypes(include=['float64', 'int64']).columns
            if len(numeric_cols) > 0:
                q_sim = df[numeric_cols[0]]
            else:
                raise ValueError(f"No streamflow column found in {sim_file}")

        q_sim.name = 'streamflow_cms'
        return q_sim

    def _extract_from_basin_daily(self, sim_file: Path) -> pd.Series:
        """Extract streamflow from RHESSys basin daily file"""
        # RHESSys basin daily format varies - try whitespace-separated
        df = pd.read_csv(sim_file, sep=r'\s+', comment='#')

        # Construct date from year/month/day columns
        if all(col in df.columns for col in ['year', 'month', 'day']):
            df['date'] = pd.to_datetime(df[['year', 'month', 'day']])
            df.set_index('date', inplace=True)
        elif 'DATE' in df.columns:
            df['date'] = pd.to_datetime(df['DATE'])
            df.set_index('date', inplace=True)

        # Find streamflow column
        q_col = None
        for col in ['streamflow', 'Qout', 'discharge', 'streamflow_m3s', 'Q']:
            if col in df.columns:
                q_col = col
                break

        if q_col is None:
            # Look for any column containing 'stream' or 'flow'
            for col in df.columns:
                if 'stream' in col.lower() or 'flow' in col.lower() or col.lower() == 'q':
                    q_col = col
                    break

        if q_col is None:
            raise ValueError(f"No streamflow column found in {sim_file}")

        q_sim = df[q_col]
        q_sim.name = 'streamflow_cms'
        return q_sim
