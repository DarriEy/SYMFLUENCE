name: Cross-Platform Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

defaults:
  run:
    shell: bash

concurrency:
  group: cross-platform-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # MATRIX TEST: Unit tests across all OS/Python combinations
  # ===========================================================================
  unit-tests-matrix:
    name: Unit Tests (${{ matrix.os }}, Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]  # Linux, ARM Mac (M1/M2)
        python-version: ['3.9', '3.10', '3.11', '3.12']
        exclude:
          # Python 3.12 may have compatibility issues with some deps
          - python-version: '3.12'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install minimal system dependencies
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            sudo apt-get update
            sudo apt-get install -y gdal-bin libgdal-dev
          elif [[ "${{ matrix.os }}" == "macos-"* ]]; then
            brew install gdal
          fi

      - name: Install Python dependencies
        env:
          RPY2_CFFI_MODE: ABI  # Skip R requirement for rpy2
        run: |
          python -m pip install --upgrade pip

          # Install GDAL Python bindings
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            GDAL_VERSION=$(gdal-config --version)
            pip install GDAL==$GDAL_VERSION
          elif [[ "${{ matrix.os }}" == "macos-"* ]]; then
            # macOS GDAL from brew - install compatible version
            GDAL_VERSION=$(gdal-config --version)
            GDAL_MAJOR=$(echo $GDAL_VERSION | cut -d. -f1)
            GDAL_MINOR=$(echo $GDAL_VERSION | cut -d. -f2)
            GDAL_PATCH=$(echo $GDAL_VERSION | cut -d. -f3 | cut -d_ -f1)
            NEXT_PATCH=$((GDAL_PATCH + 1))
            pip install "GDAL>=${GDAL_MAJOR}.${GDAL_MINOR}.${GDAL_PATCH},<${GDAL_MAJOR}.${GDAL_MINOR}.${NEXT_PATCH}"
          fi

          # Install package with dev dependencies
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install -e ".[dev]" || pip install -e .

      - name: Run unit tests
        run: |
          pytest -v --tb=short -m "unit" tests/unit/ || echo "No unit tests found"

  # ===========================================================================
  # BINARY VALIDATION: Test external tools on each platform
  # ===========================================================================
  binary-validation-matrix:
    name: Binary Validation (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]  # Linux, ARM Mac (M1/M2)
        include:
          - os: ubuntu-latest
            python-version: '3.11'
          - os: macos-latest  # ARM Mac (M1/M2)
            python-version: '3.11'

    env:
      SYMFLUENCE_CODE: ${{ github.workspace }}
      SYMFLUENCE_DATA: ${{ github.workspace }}/symfluence_data

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gfortran cmake \
            openmpi-bin libopenmpi-dev \
            gdal-bin libgdal-dev \
            libnetcdf-dev libnetcdff-dev \
            libhdf5-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install gcc cmake open-mpi netcdf netcdf-fortran hdf5 gdal

      - name: Install Python dependencies
        env:
          RPY2_CFFI_MODE: ABI  # Skip R requirement for rpy2
        run: |
          python -m pip install --upgrade pip

          if [[ "${{ runner.os }}" == "Linux" ]]; then
            GDAL_VERSION=$(gdal-config --version)
            pip install GDAL==$GDAL_VERSION
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            # macOS GDAL from brew - install compatible version
            GDAL_VERSION=$(gdal-config --version)
            GDAL_MAJOR=$(echo $GDAL_VERSION | cut -d. -f1)
            GDAL_MINOR=$(echo $GDAL_VERSION | cut -d. -f2)
            GDAL_PATCH=$(echo $GDAL_VERSION | cut -d. -f3 | cut -d_ -f1)
            NEXT_PATCH=$((GDAL_PATCH + 1))
            pip install "GDAL>=${GDAL_MAJOR}.${GDAL_MINOR}.${GDAL_PATCH},<${GDAL_MAJOR}.${GDAL_MINOR}.${NEXT_PATCH}"
          fi

          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install -e .

      - name: Cache external tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: ${{ env.SYMFLUENCE_DATA }}/installs
          key: symfluence-tools-${{ runner.os }}-${{ runner.arch }}-v2

      - name: Build external tools
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          mkdir -p "${{ env.SYMFLUENCE_DATA }}"
          chmod +x ./symfluence
          ./symfluence --install

      - name: Add tools to PATH
        run: |
          echo "${{ env.SYMFLUENCE_DATA }}/installs/summa/bin" >> $GITHUB_PATH
          echo "${{ env.SYMFLUENCE_DATA }}/installs/mizuRoute/route/bin" >> $GITHUB_PATH
          if [[ -d "${{ env.SYMFLUENCE_DATA }}/installs/TauDEM/bin" ]]; then
            echo "${{ env.SYMFLUENCE_DATA }}/installs/TauDEM/bin" >> $GITHUB_PATH
          fi

      - name: Validate binaries
        env:
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/tests
        run: |
          pytest -v --tb=short -s tests/e2e/test_install_validate.py::test_binary_validation || echo "Binary validation completed with warnings"

  # ===========================================================================
  # INTEGRATION: Quick integration tests (Linux + macOS subset)
  # ===========================================================================
  integration-tests-matrix:
    name: Integration Tests (${{ matrix.os }}, Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25

    strategy:
      fail-fast: false
      matrix:
        include:
          # Test on Linux with multiple Python versions
          - os: ubuntu-latest
            python-version: '3.11'
          # Test on macOS with latest Python
          - os: macos-latest  # ARM Mac (M1/M2)
            python-version: '3.11'

    env:
      SYMFLUENCE_CODE: ${{ github.workspace }}
      SYMFLUENCE_DATA: ${{ github.workspace }}/symfluence_data

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gfortran cmake \
            openmpi-bin libopenmpi-dev \
            gdal-bin libgdal-dev \
            libnetcdf-dev libnetcdff-dev \
            libhdf5-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install gcc cmake open-mpi netcdf netcdf-fortran hdf5 gdal

      - name: Install Python dependencies
        env:
          RPY2_CFFI_MODE: ABI  # Skip R requirement for rpy2
        run: |
          python -m pip install --upgrade pip

          if [[ "${{ runner.os }}" == "Linux" ]]; then
            GDAL_VERSION=$(gdal-config --version)
            pip install GDAL==$GDAL_VERSION
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            # macOS GDAL from brew - install compatible version
            GDAL_VERSION=$(gdal-config --version)
            GDAL_MAJOR=$(echo $GDAL_VERSION | cut -d. -f1)
            GDAL_MINOR=$(echo $GDAL_VERSION | cut -d. -f2)
            GDAL_PATCH=$(echo $GDAL_VERSION | cut -d. -f3 | cut -d_ -f1)
            NEXT_PATCH=$((GDAL_PATCH + 1))
            pip install "GDAL>=${GDAL_MAJOR}.${GDAL_MINOR}.${GDAL_PATCH},<${GDAL_MAJOR}.${GDAL_MINOR}.${NEXT_PATCH}"
          fi

          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install -e .

      - name: Cache external tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: ${{ env.SYMFLUENCE_DATA }}/installs
          key: symfluence-tools-${{ runner.os }}-${{ runner.arch }}-v2

      - name: Build external tools
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          mkdir -p "${{ env.SYMFLUENCE_DATA }}"
          chmod +x ./symfluence
          ./symfluence --install

      - name: Add tools to PATH
        run: |
          echo "${{ env.SYMFLUENCE_DATA }}/installs/summa/bin" >> $GITHUB_PATH
          echo "${{ env.SYMFLUENCE_DATA }}/installs/mizuRoute/route/bin" >> $GITHUB_PATH
          if [[ -d "${{ env.SYMFLUENCE_DATA }}/installs/TauDEM/bin" ]]; then
            echo "${{ env.SYMFLUENCE_DATA }}/installs/TauDEM/bin" >> $GITHUB_PATH
          fi

      - name: Run integration tests
        env:
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/tests
        run: |
          # Run basic integration tests (not full workflows)
          pytest -v --tb=short -m "integration and not slow" tests/integration/ || echo "Integration tests completed"

      - name: Upload test outputs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-outputs-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            ${{ env.SYMFLUENCE_DATA }}/*/simulations/
            ${{ env.SYMFLUENCE_DATA }}/*/settings/
          if-no-files-found: ignore

  # ===========================================================================
  # SUMMARY: Report overall status
  # ===========================================================================
  cross-platform-summary:
    name: Cross-Platform Test Summary
    needs: [unit-tests-matrix, binary-validation-matrix, integration-tests-matrix]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "========================================="
          echo "Cross-Platform Test Summary"
          echo "========================================="
          echo "Unit Tests: ${{ needs.unit-tests-matrix.result }}"
          echo "Binary Validation: ${{ needs.binary-validation-matrix.result }}"
          echo "Integration Tests: ${{ needs.integration-tests-matrix.result }}"
          echo "========================================="

          if [[ "${{ needs.unit-tests-matrix.result }}" != "success" ]] || \
             [[ "${{ needs.binary-validation-matrix.result }}" != "success" ]] || \
             [[ "${{ needs.integration-tests-matrix.result }}" != "success" ]]; then
            echo "❌ Some tests failed"
            exit 1
          else
            echo "✅ All cross-platform tests passed!"
          fi
