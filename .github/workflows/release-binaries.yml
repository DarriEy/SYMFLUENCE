name: Release Binaries

on:
  release:
    types: [created, published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.7.0)'
        required: true
        type: string

defaults:
  run:
    shell: bash

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false  # Don't cancel releases

jobs:
  build-and-release:
    name: Build & Release (${{ matrix.platform }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux-x86_64
            python-version: '3.11'
          - os: macos-latest  # ARM Mac (M1/M2)
            platform: macos-arm64
            python-version: '3.11'

    runs-on: ${{ matrix.os }}
    timeout-minutes: 90

    env:
      SYMFLUENCE_CODE: ${{ github.workspace }}
      SYMFLUENCE_DATA: ${{ github.workspace }}/symfluence_data
      RPY2_CFFI_MODE: ABI

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # ========================================================================
      # Linux System Dependencies
      # ========================================================================
      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gfortran cmake \
            openmpi-bin libopenmpi-dev \
            gdal-bin libgdal-dev \
            libnetcdf-dev libnetcdff-dev \
            libhdf5-dev libudunits2-dev

      - name: Configure compiler env (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "CC=mpicc" >> $GITHUB_ENV
          echo "CXX=mpicxx" >> $GITHUB_ENV
          echo "FC=gfortran" >> $GITHUB_ENV

      # ========================================================================
      # macOS System Dependencies
      # ========================================================================
      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install gcc cmake open-mpi netcdf netcdf-fortran hdf5 gdal udunits

          # Set up Fortran compiler paths
          GCC_VER=$(ls /opt/homebrew/bin/gfortran-* 2>/dev/null | head -1 | sed 's/.*gfortran-//')
          if [ -n "$GCC_VER" ]; then
            echo "FC=/opt/homebrew/bin/gfortran-${GCC_VER}" >> $GITHUB_ENV
            echo "CC=/opt/homebrew/bin/gcc-${GCC_VER}" >> $GITHUB_ENV
            echo "CXX=/opt/homebrew/bin/g++-${GCC_VER}" >> $GITHUB_ENV
            echo "/opt/homebrew/bin" >> $GITHUB_PATH
          fi

      # ========================================================================
      # Build Tools
      # ========================================================================
      - name: Free up disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Build external tools
        run: |
          mkdir -p "${{ env.SYMFLUENCE_DATA }}"
          chmod +x ./symfluence
          ./symfluence --install

      # ========================================================================
      # Generate Release Artifacts
      # ========================================================================
      - name: Generate toolchain metadata
        run: |
          set -e
          chmod +x ./scripts/generate_toolchain.sh
          ./scripts/generate_toolchain.sh \
            "${{ env.SYMFLUENCE_DATA }}/installs" \
            "${{ env.SYMFLUENCE_DATA }}/installs/toolchain.json" \
            "${{ matrix.platform }}"

      - name: Stage release artifacts
        run: |
          set -e
          chmod +x ./scripts/stage_release_artifacts.sh
          mkdir -p ./release
          ./scripts/stage_release_artifacts.sh \
            "${{ matrix.platform }}" \
            "${{ env.SYMFLUENCE_DATA }}/installs" \
            "./release"

      - name: Verify binary portability
        run: |
          set -e
          chmod +x ./scripts/verify_binary_portability.sh
          ./scripts/verify_binary_portability.sh \
            "./release/symfluence-tools/bin" || {
            echo "⚠️  Portability verification had warnings but continuing..."
            echo "   Review the output above for potential issues"
          }

      - name: Create release tarball
        run: |
          set -e
          chmod +x ./scripts/create_release_tarball.sh

          # Get version from tag or input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${{ github.ref_name }}"
          fi

          ./scripts/create_release_tarball.sh \
            "$VERSION" \
            "${{ matrix.platform }}" \
            "./release/symfluence-tools" \
            "./release"

      - name: Test artifact relocatability
        run: |
          set -e
          echo "Testing relocated binaries..."

          # Extract to temporary location
          mkdir -p /tmp/symfluence-test
          cd /tmp/symfluence-test
          tar -xzf $GITHUB_WORKSPACE/release/symfluence-tools-*.tar.gz

          # Test binaries run without original install directory
          echo "→ Testing SUMMA..."
          if [ -f "./symfluence-tools/bin/summa" ]; then
            ./symfluence-tools/bin/summa --version 2>&1 | head -5 || echo "  SUMMA version check completed"
          fi

          echo "→ Testing NGEN..."
          if [ -f "./symfluence-tools/bin/ngen" ]; then
            ./symfluence-tools/bin/ngen --help 2>&1 | head -5 || echo "  NGEN help check completed"
          fi

          echo "✓ Relocatability test complete"

      # ========================================================================
      # Upload to GitHub Release
      # ========================================================================
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          files: |
            release/symfluence-tools-*.tar.gz
            release/symfluence-tools-*.sha256
          fail_on_unmatched_files: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: symfluence-tools-${{ matrix.platform }}
          path: |
            release/symfluence-tools-*.tar.gz
            release/symfluence-tools-*.sha256
          retention-days: 90

  # ===========================================================================
  # Release Summary
  # ===========================================================================
  release-summary:
    name: Release Summary
    needs: build-and-release
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Summary
        run: |
          echo "========================================="
          echo "Release Build Summary"
          echo "========================================="
          echo "Status: ${{ needs.build-and-release.result }}"

          if [ "${{ needs.build-and-release.result }}" = "success" ]; then
            echo "✅ All platform builds completed successfully"
            echo ""
            echo "Release artifacts uploaded to:"

            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              TAG="${{ github.event.inputs.tag }}"
            else
              TAG="${{ github.ref_name }}"
            fi

            echo "https://github.com/${{ github.repository }}/releases/tag/${TAG}"
            echo ""
            echo "Artifacts:"
            echo "  - symfluence-tools-${TAG}-linux-x86_64.tar.gz"
            echo "  - symfluence-tools-${TAG}-macos-arm64.tar.gz"
          else
            echo "❌ Release build failed"
            exit 1
          fi
