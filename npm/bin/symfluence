#!/usr/bin/env node
/**
 * SYMFLUENCE CLI wrapper
 * Provides information about installed binaries and tools
 */

const fs = require('fs');
const path = require('path');
const { getPlatformName } = require('../lib/platform');

const distDir = path.join(__dirname, '..', 'dist');
const binDir = path.join(distDir, 'bin');
const toolchainFile = path.join(distDir, 'toolchain.json');

/**
 * Check if SYMFLUENCE binaries are installed
 * @returns {boolean}
 */
function isInstalled() {
  return fs.existsSync(distDir) && fs.existsSync(binDir);
}

/**
 * Get list of installed tools
 * @returns {Array<string>}
 */
function getInstalledTools() {
  if (!fs.existsSync(binDir)) {
    return [];
  }

  return fs.readdirSync(binDir)
    .filter(f => {
      const fullPath = path.join(binDir, f);
      const stats = fs.statSync(fullPath);
      return stats.isFile() && (stats.mode & 0o111); // Executable
    })
    .sort();
}

/**
 * Read toolchain metadata
 * @returns {Object|null}
 */
function getToolchain() {
  if (!fs.existsSync(toolchainFile)) {
    return null;
  }

  try {
    return JSON.parse(fs.readFileSync(toolchainFile, 'utf8'));
  } catch (err) {
    return null;
  }
}

/**
 * Display help information
 */
function showHelp() {
  console.log('SYMFLUENCE - Hydrological Modeling Framework\n');
  console.log('Usage: symfluence [command]\n');
  console.log('Commands:');
  console.log('  info        Show installed tools and build information');
  console.log('  version     Show version information');
  console.log('  path        Show binary directory path');
  console.log('  help        Show this help message\n');
  console.log('Environment:');
  console.log('  To use tools directly, add to your PATH:');
  console.log(`  export PATH="$(npm root -g)/symfluence/dist/bin:$PATH"\n`);
  console.log('Documentation: https://github.com/DarriEy/SYMFLUENCE');
}

/**
 * Display version information
 */
function showVersion() {
  const packageJson = require('../package.json');
  const toolchain = getToolchain();

  console.log(`symfluence v${packageJson.version}`);

  if (toolchain) {
    console.log(`Platform: ${toolchain.platform || 'unknown'}`);
    console.log(`Build date: ${toolchain.build_date || 'unknown'}`);
  }
}

/**
 * Display installed tools and build information
 */
function showInfo() {
  if (!isInstalled()) {
    console.error('‚ùå SYMFLUENCE binaries not found.');
    console.error('   Run: npm install -g symfluence');
    process.exit(1);
  }

  const packageJson = require('../package.json');
  const toolchain = getToolchain();
  const tools = getInstalledTools();

  console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  console.log('‚ïë   SYMFLUENCE Installation Info             ‚ïë');
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');

  console.log(`üì¶ Version: ${packageJson.version}`);
  console.log(`üìç Platform: ${getPlatformName()}`);

  if (toolchain) {
    console.log(`üîß Build Platform: ${toolchain.platform || 'unknown'}`);
    console.log(`üìÖ Build Date: ${toolchain.build_date || 'unknown'}`);

    if (toolchain.compilers) {
      console.log('\nüõ†Ô∏è  Compilers:');
      if (toolchain.compilers.fortran) {
        console.log(`   Fortran: ${toolchain.compilers.fortran}`);
      }
      if (toolchain.compilers.c) {
        console.log(`   C: ${toolchain.compilers.c}`);
      }
    }

    if (toolchain.libraries) {
      console.log('\nüìö Libraries:');
      if (toolchain.libraries.netcdf) {
        console.log(`   NetCDF: ${toolchain.libraries.netcdf}`);
      }
      if (toolchain.libraries.hdf5) {
        console.log(`   HDF5: ${toolchain.libraries.hdf5}`);
      }
    }
  }

  console.log('\nüî® Installed Tools:');
  if (tools.length === 0) {
    console.log('   (none found)');
  } else {
    tools.forEach(tool => {
      const toolPath = path.join(binDir, tool);
      console.log(`   ‚úì ${tool}`);

      // Show additional info from toolchain if available
      if (toolchain && toolchain.tools && toolchain.tools[tool]) {
        const toolInfo = toolchain.tools[tool];
        if (toolInfo.commit) {
          console.log(`     Commit: ${toolInfo.commit.substring(0, 8)}`);
        }
        if (toolInfo.branch) {
          console.log(`     Branch: ${toolInfo.branch}`);
        }
      }
    });
  }

  console.log('\nüìÇ Binary Directory:');
  console.log(`   ${binDir}`);

  console.log('\nüí° Usage:');
  console.log('   Add to PATH:');
  console.log(`     export PATH="${binDir}:$PATH"`);
  console.log('   Or use full path:');
  if (tools.length > 0) {
    console.log(`     ${path.join(binDir, tools[0])} --help`);
  }

  console.log('\nüìñ Documentation:');
  console.log('   https://github.com/DarriEy/SYMFLUENCE');
  console.log('   https://github.com/DarriEy/SYMFLUENCE/blob/main/docs/SYSTEM_REQUIREMENTS.md\n');
}

/**
 * Show binary directory path
 */
function showPath() {
  if (!isInstalled()) {
    console.error('‚ùå SYMFLUENCE binaries not found.');
    process.exit(1);
  }
  console.log(binDir);
}

/**
 * Main CLI entry point
 */
function main() {
  const args = process.argv.slice(2);
  const command = args[0] || 'help';

  switch (command) {
    case 'info':
      showInfo();
      break;

    case 'version':
    case '-v':
    case '--version':
      showVersion();
      break;

    case 'path':
      showPath();
      break;

    case 'help':
    case '-h':
    case '--help':
    default:
      showHelp();
      break;
  }
}

main();
