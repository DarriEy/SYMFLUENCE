# npm Token Setup for GitHub Actions

## Token Requirements (as of 2025)

- ‚úÖ **Granular Access Tokens** required (classic tokens revoked)
- ‚è±Ô∏è **Maximum expiration**: 90 days
- üîê **2FA required** by default

## Creating a Granular Access Token

### Via Web UI (Recommended)

1. **Go to npm tokens page**:
   - URL: https://www.npmjs.com/settings/darriey/tokens/granular-access-token/new
   - Or: npm website ‚Üí Account ‚Üí Access Tokens ‚Üí Generate New Token ‚Üí Granular Access Token

2. **Configure token**:
   ```
   Token name:        SYMFLUENCE_GITHUB_ACTIONS
   Expiration:        90 days (maximum)
   ```

3. **Set permissions**:
   ```
   Packages and scopes: Only select packages and scopes
   Package:             symfluence
   Permissions:         Read and write
   ```

4. **Generate and copy token**
   - Token format: `npm_xxxxxxxxxxxxxxxxxxxxxxxxxx`
   - ‚ö†Ô∏è **Save it immediately** - you can't view it again!

## Adding Token to GitHub

1. Go to repository secrets:
   - URL: https://github.com/DarriEy/SYMFLUENCE/settings/secrets/actions

2. Click **"New repository secret"**

3. Configure:
   ```
   Name:  NPM_TOKEN
   Value: npm_xxxxxxxxxxxxxxxxxxxxxxxxxx
   ```

4. Click **"Add secret"**

## Token Maintenance

### Expiration Reminder

Granular tokens expire after 90 days. Set a calendar reminder for:

**Current token created**: YYYY-MM-DD
**Expiration date**: YYYY-MM-DD + 90 days

### Renewing Token

1. Create new token (follow steps above)
2. Update GitHub secret with new token value
3. Old token will be automatically invalidated

### Monitoring

Check token status:
- npm dashboard: https://www.npmjs.com/settings/darriey/tokens
- GitHub Actions: Watch for authentication failures in release workflow

## Testing Token

### Test npm publish (dry run)

```bash
# In npm/ directory
NPM_TOKEN=your_token_here npm publish --dry-run
```

### Test via GitHub Actions

```bash
# Trigger workflow with dry-run
gh workflow run release-binaries.yml -f tag=v0.5.9-test

# Monitor workflow
gh run watch
```

## Troubleshooting

### "Invalid token" error
- Token may have expired (90-day limit)
- Token may not have write permissions for 'symfluence' package
- Token may be for wrong npm account

### "Package not found" error
- Package name in npm/package.json must be 'symfluence'
- Account must have permission to publish 'symfluence'
- If first publish: package name may be taken (check npmjs.com/package/symfluence)

### "One-time password required"
- Enable 2FA on npm account
- For automation, use granular token (doesn't require OTP after creation)

## Security Best Practices

‚úÖ **DO**:
- Use granular tokens for CI/CD
- Set minimum required permissions (read and write for specific package only)
- Rotate tokens every 90 days
- Use GitHub secrets (never commit tokens)

‚ùå **DON'T**:
- Use classic tokens (revoked)
- Share tokens or commit them to git
- Give tokens broader permissions than needed
- Forget to renew before expiration

## First-Time Package Publication

If this is the first time publishing 'symfluence' to npm:

1. **Check availability**:
   ```bash
   npm view symfluence
   # Should return: npm ERR! 404 'symfluence' is not in this registry
   ```

2. **Publish manually first** (recommended):
   ```bash
   cd npm/
   npm publish
   ```

3. **Then enable automated publishing** via GitHub Actions

## Links

- npm tokens: https://www.npmjs.com/settings/darriey/tokens
- GitHub secrets: https://github.com/DarriEy/SYMFLUENCE/settings/secrets/actions
- npm package: https://www.npmjs.com/package/symfluence (after first publish)
