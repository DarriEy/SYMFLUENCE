### ============================================= SYMFLUENCE configuration file ============================================================
# SUMMA Model Configuration for Paradise - Section 4.10b SCA & Soil Moisture Multivariate Evaluation
# Compare simulated SCA vs MODIS and simulated soil moisture vs SMAP
### ============================================= 1. Global settings: =====================================================================

# Main paths
SYMFLUENCE_DATA_DIR: "/Users/darrieythorsson/compHydro/code/SYMFLUENCE_data/"
SYMFLUENCE_CODE_DIR: "/Users/darrieythorsson/compHydro/code/SYMFLUENCE"

# Experiment settings
DOMAIN_NAME: paradise_multivar
EXPERIMENT_ID: paradise_sca_sm
EXPERIMENT_TIME_START: 2015-04-01 01:00
EXPERIMENT_TIME_END: 2023-12-31 23:00
CALIBRATION_PERIOD: 2016-10-01, 2020-09-30
EVALUATION_PERIOD:  2020-10-01, 2023-09-30
SPINUP_PERIOD: 2015-04-01, 2016-09-30

# Data access settings
DATA_ACCESS: "cloud"
DEM_SOURCE: "copernicus"
DOWNLOAD_DEM: true
LAND_CLASS_SOURCE: "modis"
DOWNLOAD_LAND_COVER: true
DOWNLOAD_SOIL: true

# Computational settings
MPI_PROCESSES: 1
FORCE_RUN_ALL_STEPS: False

### ============================================= 2. Geospatial settings: =================================================================
# Coordinate settings (Paradise, Mt. Rainier area)
POUR_POINT_COORDS: 46.7867/-121.7476
BOUNDING_BOX_COORDS: 47.05/-122.0/46.55/-121.5

# Pour point shapefile path
POUR_POINT_SHP_PATH: default
POUR_POINT_SHP_NAME: default

# Domain representation settings
DOMAIN_DEFINITION_METHOD: lumped
ROUTING_DELINEATION: lumped

GEOFABRIC_TYPE: TDX
STREAM_THRESHOLD: 5000
LUMPED_WATERSHED_METHOD: TauDEM
CLEANUP_INTERMEDIATE_FILES: True
DELINEATE_BY_POURPOINT: True
MOVE_OUTLETS_MAX_DISTANCE: 200
MIN_GRU_SIZE: 1

# Domain discretization settings
SUB_GRID_DISCRETIZATION: GRUS
ELEVATION_BAND_SIZE: 200
MIN_HRU_SIZE: 4
RADIATION_CLASS_NUMBER: 5
ASPECT_CLASS_NUMBER: 8
ASPECT_PATH: default

# Shapefile settings - Catchment shape
CATCHMENT_PATH: default
CATCHMENT_SHP_NAME: default
CATCHMENT_SHP_LAT: center_lat
CATCHMENT_SHP_LON: center_lon
CATCHMENT_SHP_AREA: HRU_area
CATCHMENT_SHP_HRUID: HRU_ID
CATCHMENT_SHP_GRUID: GRU_ID

# Shapefile settings - Basins shape
RIVER_BASINS_PATH: default
RIVER_BASINS_NAME: default
RIVER_BASIN_SHP_RM_GRUID: GRU_ID
RIVER_BASIN_SHP_HRU_TO_SEG: gru_to_seg
RIVER_BASIN_SHP_AREA: GRU_area

# Shapefile settings - River network shape
RIVER_NETWORK_SHP_PATH: default
RIVER_NETWORK_SHP_NAME: default
RIVER_NETWORK_SHP_LENGTH: Length
RIVER_NETWORK_SHP_SEGID: LINKNO
RIVER_NETWORK_SHP_DOWNSEGID: DSLINKNO
RIVER_NETWORK_SHP_SLOPE: Slope

# Geospatial data paths
OUTPUT_BASINS_PATH: default
OUTPUT_RIVERS_PATH: default
DEM_PATH: default
DEM_NAME: default
TAUDEM_DIR: default
OUTPUT_DIR: default
CATCHMENT_PLOT_DIR: default
SOIL_CLASS_PATH: default
SOIL_CLASS_NAME: default
LAND_CLASS_PATH: default
LAND_CLASS_NAME: default
RADIATION_PATH: default

# Tool paths
DATATOOL_PATH: default
GISTOOL_PATH: default
EASYMORE_CLIENT: easymore cli
DATATOOL_DATASET_ROOT: /work/comphyd_lab/data/meteorological-data/
DATATOOL_CACHE: /home/darri.eythorsson
TOOL_ACCOUNT: def-mclark
GISTOOL_DATASET_ROOT: /work/comphyd_lab/data/geospatial-data/
GISTOOL_LIB_PATH: /work/comphyd_lab/envs/r-env/
TOOL_CACHE: /home/darri.eythorsson/cache
EASYMORE_CACHE: /home/darri.eythorsson/easymore/
EASYMORE_JOB_CONF: "installs/MAF/02_model_agnostic_component/easymore-job.slurm"
CLUSTER_JSON: /work/comphyd_lab/users/darri/data/SYMFLUENCE_data/installs/datatool/etc/clusters/ucalgary-arc.json

### ============================================= 3. Model Agnostic settings: =============================================================

# Forcing data settings
FORCING_DATASET: RDRS
FORCING_VARIABLES: default
FORCING_MEASUREMENT_HEIGHT: 2
FORCING_TIME_STEP_SIZE: 3600
APPLY_LAPSE_RATE: True
LAPSE_RATE: 0.0065
FORCING_SHAPE_LAT_NAME: lat
FORCING_SHAPE_LON_NAME: lon
FORCING_PATH: default

# EM-Earth forcing supplementation settings
SUPPLEMENT_FORCING: False
EM_EARTH_PRCP_DIR: "/anvil/datasets/meteorological/EM-Earth/EM_Earth_v1/deterministic_hourly/prcp/NorthAmerica"
EM_EARTH_TMEAN_DIR: "/anvil/datasets/meteorological/EM-Earth/EM_Earth_v1/deterministic_hourly/tmean/NorthAmerica"

# Intersection paths
INTERSECT_SOIL_PATH: default
INTERSECT_SOIL_NAME: catchment_with_soilclass.shp
INTERSECT_ROUTING_PATH: default
INTERSECT_ROUTING_NAME: catchment_with_routing_basins.shp
INTERSECT_DEM_PATH: default
INTERSECT_DEM_NAME: catchment_with_dem.shp
INTERSECT_LAND_PATH: default
INTERSECT_LAND_NAME: catchment_with_landclass.shp

### ============================================= 4. Model Specific settings: =============================================================

# Model settings
HYDROLOGICAL_MODEL: SUMMA
ROUTING_MODEL: none

# SUMMA settings
SETTINGS_SUMMA_CONNECT_HRUS: yes
SETTINGS_SUMMA_TRIALPARAM_N: 0

# SUMMA Decision options
DECISION_OPTIONS:
  snowIncept:
    - lightSnow
  compaction:
    - anderson
  snowLayers:
    - CLM_2010
  alb_method:
    - varDecay
  thCondSnow:
    - jrdn1991

# Soil depth calibration settings
CALIBRATE_DEPTH: False
DEPTH_TOTAL_MULT_BOUNDS: [0.1, 5.0]
DEPTH_SHAPE_FACTOR_BOUNDS: [0.1, 3.0]

# SUMMA Paths and filenames
SETTINGS_SUMMA_PATH: default
SETTINGS_SUMMA_FILEMANAGER: fileManager.txt
SETTINGS_SUMMA_FORCING_LIST: forcingFileList.txt
SETTINGS_SUMMA_COLDSTATE: coldState.nc
SETTINGS_SUMMA_TRIALPARAMS: trialParams.nc
SETTINGS_SUMMA_ATTRIBUTES: attributes.nc
SETTINGS_SUMMA_OUTPUT: outputControl.txt
SETTINGS_SUMMA_BASIN_PARAMS_FILE: basinParamInfo.txt
SETTINGS_SUMMA_LOCAL_PARAMS_FILE: localParamInfo.txt
SUMMA_INSTALL_PATH: default
SUMMA_EXE: summa_sundials.exe

# SUMMA Parameters to calibrate (snow + soil moisture relevant)
PARAMS_TO_CALIBRATE: albedoMax,albedoMinWinter,albedoMinSpring,newSnowDenMin,Fcapil,k_soil,theta_sat,critSoilWilting,theta_res,f_impede,snowfrz_scale
BASIN_PARAMS_TO_CALIBRATE: routingGammaShape,routingGammaScale

# Parallel SUMMA settings
SETTINGS_SUMMA_USE_PARALLEL_SUMMA: false
SETTINGS_SUMMA_CPUS_PER_TASK: 32
SETTINGS_SUMMA_TIME_LIMIT: 01:00:00
SETTINGS_SUMMA_MEM: 5
SETTINGS_SUMMA_GRU_COUNT: 1
SETTINGS_SUMMA_GRU_PER_JOB: 1
SETTINGS_SUMMA_PARALLEL_PATH: default
SETTINGS_SUMMA_PARALLEL_EXE: summa.exe

# Mizuroute settings
SETTINGS_MIZU_WITHIN_BASIN: 0
SETTINGS_MIZU_ROUTING_DT: 3600
SETTINGS_MIZU_ROUTING_UNITS: m/s
SETTINGS_MIZU_ROUTING_VAR: averageRoutedRunoff
SETTINGS_MIZU_OUTPUT_FREQ: single
SETTINGS_MIZU_OUTPUT_VARS: 1
SETTINGS_MIZU_MAKE_OUTLET: n/a
SETTINGS_MIZU_NEEDS_REMAP: no

# Mizuroute Paths and filenames
SETTINGS_MIZU_PATH: default
MIZUROUTE_INSTALL_PATH: default
MIZUROUTE_EXE: mizuroute.exe
SETTINGS_MIZU_TOPOLOGY: topology.nc
SETTINGS_MIZU_PARAMETERS: param.nml.default
SETTINGS_MIZU_CONTROL_FILE: mizuroute.control
SETTINGS_MIZU_REMAP: routing_remap.nc

# Model results path
EXPERIMENT_OUTPUT_SUMMA: default
EXPERIMENT_OUTPUT_MIZUROUTE: default
EXPERIMENT_LOG_MIZUROUTE: default
EXPERIMENT_LOG_SUMMA: default

### ============================================= 5. Evaluation settings: =================================================================

# Simulation settings
# SIM_REACH_ID: default  # Leave unset for lumped domain (defaults to None)
SIMULATIONS_PATH: default

# Observation data settings
OBSERVATIONS_PATH: default

# Streamflow observation data (disabled for this multivar experiment)
STREAMFLOW_DATA_PROVIDER: none
DOWNLOAD_USGS_DATA: False
DOWNLOAD_WSC_DATA: False
STATION_ID: none
STREAMFLOW_RAW_PATH: default
STREAMFLOW_RAW_NAME: default
STREAMFLOW_PROCESSED_PATH: default

### ============================================= 6. Multivariate evaluation settings: ====================================================

# Multivariate comparison settings
MULTIVAR_EVALUATION: True
MULTIVAR_TARGETS:
  - variable: SCA
    source: MODIS
    product: MOD10A1
    metric: accuracy
    weight: 0.25
  - variable: soil_moisture
    source: SMAP
    product: SMAP_L3_SM_P
    metric: correlation
    weight: 0.25
  - variable: SWE
    source: SNOTEL
    metric: KGE
    weight: 0.25
  - variable: soil_moisture
    source: ISMN
    network: SCAN
    metric: correlation
    weight: 0.25

# MODIS Snow Cover settings
MODIS_SCA_PRODUCT: MOD10A1
MODIS_SCA_PATH: default
MODIS_SCA_VARIABLE: NDSI_Snow_Cover
MODIS_SCA_THRESHOLD: 50
MODIS_CLOUD_FILTER: True
MODIS_CLOUD_MAX_FRACTION: 0.2

# SMAP Soil Moisture settings
SMAP_PRODUCT: SPL4SMGP
SMAP_PATH: default
SMAP_SURFACE_DEPTH_M: 0.05
SMAP_ROOTZONE_DEPTH_M: 1.0
SMAP_USE_OPENDAP: false

# Data download flags
DOWNLOAD_SNOTEL: true
DOWNLOAD_ISMN: true
DOWNLOAD_SMAP: true
DOWNLOAD_MODIS_SNOW: true

# Explicit observation sources to acquire
ADDITIONAL_OBSERVATIONS: MODIS_SNOW, SNOTEL, SMAP, ISMN

# SNOTEL settings
SNOTEL_PATH: default
SNOTEL_VARIABLES: [SWE, snow_depth, air_temperature, precipitation]
SNOTEL_SEARCH_RADIUS: 50
SNOTEL_MAX_STATIONS: 5

# ISMN Soil Moisture settings
ISMN_PATH: default
ISMN_API_BASE: https://ismn.earth/dataviewer
ISMN_MAX_STATIONS: 3
ISMN_SEARCH_RADIUS_KM: 50
ISMN_TARGET_DEPTH_M: 0.05
ISMN_TEMPORAL_AGGREGATION: daily_mean

# MODIS SCA download settings
MODIS_SCA_PRODUCTS: ['MOD10A1.061', 'MYD10A1.061']
MODIS_SCA_MERGE: true
MODIS_SCA_MERGE_STRATEGY: max
MODIS_SCA_CLOUD_FILTER: true
MODIS_SCA_NORMALIZE: true

### ============================================= 7. Optimization settings: ===============================================================

OPTIMIZATION_METHODS: [iteration]

# Iterative optimization settings
ITERATIVE_OPTIMIZATION_ALGORITHM: DDS
NUMBER_OF_ITERATIONS: 1000
DDS_R: 0.2
POPULATION_SIZE: 20
OPTIMIZATION_METRIC: KGE
TARGET_METRIC: KGE

# SUMMA parameter bounds
SUMMA_PARAM_BOUNDS:
  albedoMax: [0.7, 0.95]
  albedoMinWinter: [0.5, 0.8]
  albedoMinSpring: [0.3, 0.6]
  newSnowDenMin: [50, 150]
  Fcapil: [0.001, 0.1]
  k_soil: [1e-8, 1e-4]
  theta_sat: [0.3, 0.6]
  critSoilWilting: [0.05, 0.3]
  theta_res: [0.01, 0.15]
  f_impede: [0.5, 5.0]
  snowfrz_scale: [10, 1000]
  routingGammaShape: [1.5, 5.0]
  routingGammaScale: [100, 10000]

# DDS specific settings
DDS_R: 0.2
ASYNC_DDS_POOL_SIZE: 10
ASYNC_DDS_BATCH_SIZE: 10
MAX_STAGNATION_BATCHES: 5
