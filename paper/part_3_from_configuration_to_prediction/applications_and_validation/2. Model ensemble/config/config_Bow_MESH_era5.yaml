### ============================================= SYMFLUENCE configuration file ============================================================
# MESH Model Configuration for Bow at Banff - Multi-model ensemble experiment
# This configuration uses MESH (Mod√©lisation Environnementale-Surface Hydrology)
# VERSION 3: Scientifically-justified parameter bounds for alpine catchment
#   - KSAT widened to 100 mm/hr (SoilKsatDB shows alpine glacial deposits reach 50-200 mm/hr)
#   - SDEP widened to 5.0m (effective depth averaging thin ridges + deep valley deposits)
#   - MANN_CLASS widened to 0.50 (USGS: forest overland flow 0.15-0.45, dense veg up to 0.6)
### ============================================= 1. Global settings: =====================================================================

# Main paths
SYMFLUENCE_DATA_DIR: "/Users/darrieythorsson/compHydro/code/SYMFLUENCE_data/"
SYMFLUENCE_CODE_DIR: "/Users/darrieythorsson/compHydro/code/SYMFLUENCE"

# Experiment settings
DOMAIN_NAME: Bow_at_Banff_lumped_era5
EXPERIMENT_ID: run_10
EXPERIMENT_TIME_START: 2002-01-01 01:00
EXPERIMENT_TIME_END: 2009-12-31 23:00
CALIBRATION_PERIOD: 2004-01-01, 2007-12-31
EVALUATION_PERIOD:  2008-01-01, 2009-12-31
SPINUP_PERIOD: 2002-01-01, 2003-12-31

# Computational settings
MPI_PROCESSES: 1
FORCE_RUN_ALL_STEPS: False

### ============================================= 2. Geospatial settings: =================================================================
# Coordinate settings
POUR_POINT_COORDS: 51.1722/-115.5717
BOUNDING_BOX_COORDS: 51.76/-116.55/50.95/-115.5

# Pour point shapefile path
POUR_POINT_SHP_PATH: default
POUR_POINT_SHP_NAME: default

# Domain representation settings
DOMAIN_DEFINITION_METHOD: lumped
ROUTING_DELINEATION: lumped

GEOFABRIC_TYPE: TDX
STREAM_THRESHOLD: 5000
LUMPED_WATERSHED_METHOD: TauDEM
CLEANUP_INTERMEDIATE_FILES: True
DELINEATE_BY_POURPOINT: True
MOVE_OUTLETS_MAX_DISTANCE: 200
MIN_GRU_SIZE: 1

# Domain discretization settings
SUB_GRID_DISCRETIZATION: GRUS
ELEVATION_BAND_SIZE: 200
MIN_HRU_SIZE: 4
RADIATION_CLASS_NUMBER: 5
ASPECT_CLASS_NUMBER: 8
ASPECT_PATH: default

# Shapefile settings - Catchment shape
CATCHMENT_PATH: default
CATCHMENT_SHP_NAME: default
CATCHMENT_SHP_LAT: center_lat
CATCHMENT_SHP_LON: center_lon
CATCHMENT_SHP_AREA: HRU_area
CATCHMENT_SHP_HRUID: HRU_ID
CATCHMENT_SHP_GRUID: GRU_ID

# Shapefile settings - Basins shape
RIVER_BASINS_PATH: default
RIVER_BASINS_NAME: default
RIVER_BASIN_SHP_RM_GRUID: GRU_ID
RIVER_BASIN_SHP_HRU_TO_SEG: gru_to_seg
RIVER_BASIN_SHP_AREA: GRU_area

# Shapefile settings - River network shape
RIVER_NETWORK_SHP_PATH: default
RIVER_NETWORK_SHP_NAME: default
RIVER_NETWORK_SHP_LENGTH: Length
RIVER_NETWORK_SHP_SEGID: LINKNO
RIVER_NETWORK_SHP_DOWNSEGID: DSLINKNO
RIVER_NETWORK_SHP_SLOPE: Slope

# Geospatial data paths
OUTPUT_BASINS_PATH: default
OUTPUT_RIVERS_PATH: default
DEM_PATH: default
DEM_NAME: default
SOURCE_GEOFABRIC_BASINS_PATH: /Users/darrieythorsson/compHydro/data/CWARHM_data/domain_NorthAmerica/shapefiles/catchment/8020000010-basins.gpkg
SOURCE_GEOFABRIC_RIVERS_PATH: /Users/darrieythorsson/compHydro/data/CWARHM_data/domain_NorthAmerica/shapefiles/river_network/8020000010-streamnet.gpkg
TAUDEM_DIR: default
OUTPUT_DIR: default
CATCHMENT_PLOT_DIR: default
SOIL_CLASS_PATH: default
SOIL_CLASS_NAME: default
LAND_CLASS_PATH: default
LAND_CLASS_NAME: default
RADIATION_PATH: default

# Tool paths
DATATOOL_PATH: default
GISTOOL_PATH: default
EASYMORE_CLIENT: easymore cli
DATATOOL_DATASET_ROOT: /work/comphyd_lab/data/meteorological-data/
DATATOOL_CACHE: /home/darri.eythorsson
TOOL_ACCOUNT: def-mclark
GISTOOL_DATASET_ROOT: /work/comphyd_lab/data/geospatial-data/
GISTOOL_LIB_PATH: /work/comphyd_lab/envs/r-env/
TOOL_CACHE: /home/darri.eythorsson/cache
EASYMORE_CACHE: /home/darri.eythorsson/easymore/
EASYMORE_JOB_CONF: "installs/MAF/02_model_agnostic_component/easymore-job.slurm"
CLUSTER_JSON: /work/comphyd_lab/users/darri/data/SYMFLUENCE_data/installs/datatool/etc/clusters/ucalgary-arc.json

### ============================================= 3. Model Agnostic settings: =============================================================

# Forcing data settings
FORCING_DATASET: ERA5
FORCING_VARIABLES: default
FORCING_MEASUREMENT_HEIGHT: 2
FORCING_TIME_STEP_SIZE: 3600
APPLY_LAPSE_RATE: True
LAPSE_RATE: 0.0065
FORCING_SHAPE_LAT_NAME: lat
FORCING_SHAPE_LON_NAME: lon
FORCING_PATH: default

# EM-Earth forcing supplementation settings
SUPPLEMENT_FORCING: False
EM_EARTH_PRCP_DIR: "/anvil/datasets/meteorological/EM-Earth/EM_Earth_v1/deterministic_hourly/prcp/NorthAmerica"
EM_EARTH_TMEAN_DIR: "/anvil/datasets/meteorological/EM-Earth/EM_Earth_v1/deterministic_hourly/tmean/NorthAmerica"

# Intersection paths
INTERSECT_SOIL_PATH: default
INTERSECT_SOIL_NAME: catchment_with_soilclass.shp
INTERSECT_ROUTING_PATH: default
INTERSECT_ROUTING_NAME: catchment_with_routing_basins.shp
INTERSECT_DEM_PATH: default
INTERSECT_DEM_NAME: catchment_with_dem.shp
INTERSECT_LAND_PATH: default
INTERSECT_LAND_NAME: catchment_with_landclass.shp

### ============================================= 4. Model Specific settings: =============================================================

# Model settings
HYDROLOGICAL_MODEL: MESH
ROUTING_MODEL: none                                            # MESH has internal routing

# MESH settings
MESH_INSTALL_PATH: default
MESH_EXE: mesh.exe
SETTINGS_MESH_PATH: default
EXPERIMENT_OUTPUT_MESH: default
MESH_FORCING_PATH: default
MESH_SPATIAL_MODE: lumped
MESH_SPINUP_DAYS: 730                                          # 2 years spinup
SKIP_WARM_START: true

# MESH calibration parameters (CLASS.ini + hydrology.ini)
# Added ZPLG (ponding on ground) which affects runoff timing
MESH_PARAMS_TO_CALIBRATE: KSAT,DRN,SDEP,XSLP,FLZ,PWR,ZSNL,ZPLS,ZPLG,RCHARG,XDRAINH,MANN_CLASS

# MESH Parameter descriptions:
# ===== Soil/Infiltration Parameters (CLASS.ini - control runoff generation) =====
# KSAT: Saturated hydraulic conductivity (mm/hr) - primary infiltration control
# DRN: Drainage parameter (-) - subsurface drainage rate (1=fast, 10=slow)
# SDEP: Soil depth (m) - controls water storage capacity
# XSLP: Slope (-) - affects overland flow speed
# XDRAINH: Horizontal drainage coefficient (-) - lateral subsurface flow
#
# ===== Snow/Ponding Parameters (hydrology.ini) =====
# ZSNL: Limiting snow depth (m) - below which coverage < 100%
# ZPLS: Maximum ponding depth on snow-covered areas (m)
# ZPLG: Maximum ponding depth on ground (m) - NEW: affects surface storage/runoff delay

### ============================================= 5. Evaluation settings: =================================================================

# Simulation settings
SIM_REACH_ID: 228
SIMULATIONS_PATH: default

# Observation data settings
OBSERVATIONS_PATH: default

# Observation data paths
STREAMFLOW_DATA_PROVIDER: WSC
DOWNLOAD_USGS_DATA: True
DOWNLOAD_WSC_DATA: True
STATION_ID: 05BB001
STREAMFLOW_RAW_PATH: default
STREAMFLOW_RAW_NAME: default
STREAMFLOW_PROCESSED_PATH: default
HYDAT_PATH: /work/comphyd_lab/data/geospatial-data/hydat/Hydat.sqlite3

### ============================================= 6. Optimization settings: ===============================================================

OPTIMIZATION_METHODS: [iteration]

# Iterative optimization settings
ITERATIVE_OPTIMIZATION_ALGORITHM: DDS
NUMBER_OF_ITERATIONS: 2000                                     # Increased for better convergence with 12 params
DDS_R: 0.2
POPULATION_SIZE: 20
OPTIMIZATION_METRIC: KGE
TARGET_METRIC: KGE

# MESH parameter bounds (CLASS.ini + hydrology.ini parameters)
# VERSION 3: Scientifically-justified bounds for alpine Bow River catchment
# Scientific references:
#   - KSAT: SoilKsatDB (Gupta et al. 2021) - alpine glacial deposits 50-200 mm/hr
#   - SDEP: Effective soil depth for lumped model averaging thin ridges + deep valleys
#   - MANN_CLASS: USGS WSP-2339 - forest/meadow overland flow 0.15-0.45, dense veg up to 0.6
#   - XDRAINH: High lateral flow expected in steep fractured alpine bedrock
MESH_PARAM_BOUNDS:
  # Soil/Infiltration (CLASS.ini) - scientifically justified for alpine soils
  KSAT: [0.01, 100.0]                                          # Saturated hydraulic conductivity (mm/hr) - coarse glacial deposits
  DRN: [0.5, 5.0]                                              # Drainage parameter (-) - controls subsurface drainage rate
  SDEP: [1.5, 5.0]                                             # Soil depth (m) - effective depth for lumped catchment
  XSLP: [0.005, 0.3]                                           # Slope (-) - terrain slope for overland flow
  XDRAINH: [0.01, 1.0]                                         # Horizontal drainage (-) - lateral flow in fractured bedrock
  # Baseflow (hydrology.ini) - CRITICAL for winter flow
  FLZ: [0.0001, 0.1]                                           # Baseflow recession coefficient
  PWR: [1.0, 4.0]                                              # Baseflow power exponent
  RCHARG: [0.0, 0.5]                                           # Groundwater recharge fraction
  # Snow/Ponding (hydrology.ini) - CRITICAL for alpine snowmelt timing
  ZSNL: [0.001, 0.10]                                          # Limiting snow depth (m)
  ZPLS: [0.001, 0.10]                                          # Max ponding depth on snow (m)
  ZPLG: [0.01, 0.50]                                           # Max ponding depth on ground (m)
  # Surface flow (CLASS.ini) - hydrograph shape
  MANN_CLASS: [0.01, 0.50]                                     # Manning overland flow (-) - forest/meadow (USGS WSP-2339)
MESH_FORCE_SINGLE_GRU: true
